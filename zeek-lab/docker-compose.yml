# =============================================================================
# ZEEK LAB - Laboratoire de test Network Security Monitor
# =============================================================================
#
# ARCHITECTURE (Mermaid):
# ```mermaid
# graph TB
#     subgraph zeek_net["zeek_net 172.30.0.0/24"]
#         ZEEK["üëÅÔ∏è zeek_ids<br/>172.30.0.10"]
#         TARGET["üéØ target_zeek<br/>172.30.0.100"]
#         EDITOR["üìù zeek_editor<br/>:8083"]
#         RELOAD["üîÑ zeek_reloader"]
#         LOGS["üìÅ ./logs/conn.log, http.log..."]
#     end
#     ZEEK -->|monitor| TARGET
#     ZEEK -->|write| LOGS
#     RELOAD -->|restart| ZEEK
#     LOCALHOST["üñ•Ô∏è Attaquant"] -->|nmap/scapy| TARGET
# ```
#
# ZEEK vs SNORT/SURICATA:
# - Snort/Suricata: D√©tection par signatures (r√®gles)
#   ‚Üí G√©n√®re des alertes si pattern trouv√©
# - Zeek: Analyse comportementale + scripts
#   ‚Üí G√©n√®re des logs structur√©s (conn.log, http.log, dns.log...)
#   ‚Üí Scripts personnalis√©s pour d√©tection
#
# POURQUOI ZEEK?
# - Analyse protocolaire profonde (HTTP, DNS, SSL, etc.)
# - Logs structur√©s excellents pour le forensic
# - Langage de scripting puissant pour d√©tections custom
# - Compl√©mentaire aux IDS classiques
#
# CHOIX STRAT√âGIQUES:
# - Scripts dans /site: Permet de personnaliser les d√©tections
# - Logs persistants: Analyse post-mortem des connexions
# - Restart au lieu de reload: Zeek ne supporte pas le reload √† chaud
#
# PORTS EXPOS√âS:
# - 8083: FileBrowser (√©dition des scripts)
#
# COMMANDES UTILES:
# - D√©marrer: docker compose up -d
# - Logs Zeek: docker logs -f zeek_ids
# - Voir connexions: cat ./logs/current/conn.log | zeek-cut id.orig_h id.resp_h
# =============================================================================

networks:
  zeek_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24  # Sous-r√©seau d√©di√© au lab Zeek

services:
  # ---------------------------------------------------------------------------
  # ZEEK NETWORK SECURITY MONITOR
  # ---------------------------------------------------------------------------
  # Image officielle Zeek (anciennement Bro)
  # G√©n√®re des logs d√©taill√©s pour chaque protocole d√©tect√©
  #
  # LOGS G√âN√âR√âS:
  # - conn.log: Toutes les connexions TCP/UDP/ICMP
  # - http.log: Requ√™tes HTTP (m√©thode, URI, user-agent)
  # - dns.log: Requ√™tes DNS
  # - ssl.log: Connexions TLS/SSL
  # - notice.log: Alertes g√©n√©r√©es par les scripts
  zeek-engine:
    image: zeek/zeek:lts
    container_name: zeek_ids
    networks:
      zeek_net:
        ipv4_address: 172.30.0.10  # IP fixe pour identification
    cap_add:
      - NET_ADMIN  # Capture r√©seau
      - NET_RAW    # Raw sockets
    volumes:
      # Scripts personnalis√©s (local.zeek charg√© automatiquement)
      - ./scripts:/usr/local/zeek/share/zeek/site
      # Logs persistants
      - ./logs:/usr/local/zeek/logs
    # Commande Zeek:
    # -i eth0: Interface √† surveiller
    # local: Charge le script local.zeek
    command: zeek -i eth0 local
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # TARGET SERVER (Serveur cible vuln√©rable)
  # ---------------------------------------------------------------------------
  target-zeek:
    build:
      context: ../target-server
      dockerfile: Dockerfile
    container_name: target_zeek
    hostname: acme-server
    networks:
      zeek_net:
        ipv4_address: 172.30.0.100  # IP cible pour les attaques
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # FILEBROWSER (√âditeur de scripts web)
  # ---------------------------------------------------------------------------
  # Interface web pour √©diter les scripts Zeek
  # Acc√®s: http://localhost:8083
  zeek-editor:
    image: filebrowser/filebrowser
    container_name: zeek_editor
    networks:
      - zeek_net
    ports:
      - "8083:80"
    volumes:
      - ./scripts:/srv  # Expose le r√©pertoire des scripts
    environment:
      - FB_BASEURL=/
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # AUTO-RELOADER (Red√©marrage automatique)
  # ---------------------------------------------------------------------------
  # Surveille les modifications et red√©marre Zeek
  #
  # POURQUOI RESTART AU LIEU DE RELOAD?
  # - Zeek ne supporte pas le rechargement √† chaud des scripts
  # - Un restart est n√©cessaire pour appliquer les changements
  # - Le restart est rapide (~2-3 secondes)
  zeek-reloader:
    image: alpine
    container_name: zeek_reloader
    networks:
      - zeek_net
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./scripts:/scripts  # R√©pertoire surveill√©
    entrypoint: /bin/sh -c "apk add --no-cache docker-cli inotify-tools &&
      while inotifywait -r -e modify /scripts; do
        echo '[RELOAD] Zeek scripts changed, restarting...';
        docker restart zeek_ids;
      done"
    restart: unless-stopped
