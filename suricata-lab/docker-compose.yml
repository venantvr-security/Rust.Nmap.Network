# =============================================================================
# SURICATA LAB - Laboratoire de test IDS/IPS Suricata
# =============================================================================
#
# ARCHITECTURE (Mermaid):
# ```mermaid
# graph TB
#     subgraph suricata_net["suricata_net 172.29.0.0/24"]
#         SURICATA["ü¶ä suricata_ids<br/>172.29.0.10"]
#         TARGET["üéØ target_suricata<br/>172.29.0.100"]
#         EDITOR["üìù suricata_editor<br/>:8082"]
#         EVEBOX["üìä EveBox<br/>:5636"]
#         RELOAD["üîÑ suricata_reloader"]
#         LOGS["üìÅ ./logs/eve.json"]
#     end
#     SURICATA -->|monitor| TARGET
#     SURICATA -->|write| LOGS
#     LOGS -->|read| EVEBOX
#     RELOAD -->|USR2| SURICATA
#     LOCALHOST["üñ•Ô∏è Attaquant"] -->|nmap/scapy| TARGET
# ```
#
# POURQUOI SURICATA?
# - Plus moderne que Snort, multi-thread√© natif
# - Support IPS (Intrusion Prevention) en plus de IDS
# - Format de logs EVE JSON, id√©al pour l'analyse
# - √âcosyst√®me riche (EveBox, Kibana, etc.)
#
# CHOIX STRAT√âGIQUES:
# - EveBox int√©gr√©: Visualisation des alertes en temps r√©el
# - Logs persistants: Permet l'analyse post-mortem
# - Rechargement USR2: Signal sp√©cifique √† Suricata pour reload
#
# PORTS EXPOS√âS:
# - 5636: EveBox (dashboard de visualisation des alertes)
# - 8082: FileBrowser (√©dition des r√®gles)
#
# COMMANDES UTILES:
# - D√©marrer: docker compose up -d
# - Logs Suricata: docker logs -f suricata_ids
# - Forcer reload: docker kill -s USR2 suricata_ids
# - Voir alertes: tail -f ./logs/eve.json | jq '.alert'
# =============================================================================

networks:
  suricata_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/24  # Sous-r√©seau d√©di√© au lab Suricata

services:
  # ---------------------------------------------------------------------------
  # SURICATA IDS/IPS ENGINE
  # ---------------------------------------------------------------------------
  # Image officielle OISF (Open Information Security Foundation)
  # Suricata est plus performant que Snort gr√¢ce au multi-threading
  suricata:
    image: jasonish/suricata:latest
    container_name: suricata_ids
    networks:
      suricata_net:
        ipv4_address: 172.29.0.10  # IP fixe pour identification
    cap_add:
      - NET_ADMIN  # Capture r√©seau (mode promiscuous)
      - NET_RAW    # Raw sockets pour inspection paquets
      - SYS_NICE   # Permet d'ajuster la priorit√© des threads
    volumes:
      # R√®gles personnalis√©es (local.rules)
      - ./rules:/var/lib/suricata/rules
      # Logs persistants (eve.json pour EveBox)
      - ./logs:/var/log/suricata
    command: -i eth0  # Interface √† surveiller
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # TARGET SERVER (Serveur cible vuln√©rable)
  # ---------------------------------------------------------------------------
  # M√™me serveur multi-services que les autres labs
  # Permet de comparer les d√©tections entre IDS
  target-suricata:
    build:
      context: ../target-server
      dockerfile: Dockerfile
    container_name: target_suricata
    hostname: acme-server
    networks:
      suricata_net:
        ipv4_address: 172.29.0.100  # IP cible pour les attaques
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # FILEBROWSER (√âditeur de r√®gles web)
  # ---------------------------------------------------------------------------
  # Interface web pour √©diter les r√®gles Suricata
  # Acc√®s: http://localhost:8082
  suricata-editor:
    image: filebrowser/filebrowser
    container_name: suricata_editor
    networks:
      - suricata_net
    ports:
      - "8082:80"
    volumes:
      - ./rules:/srv  # Expose le r√©pertoire des r√®gles
    environment:
      - FB_BASEURL=/
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # EVEBOX (Visualisation des alertes)
  # ---------------------------------------------------------------------------
  # Dashboard web pour analyser les alertes Suricata
  # Lit directement les fichiers eve.json g√©n√©r√©s par Suricata
  #
  # POURQUOI EVEBOX?
  # - Interface intuitive pour l'analyse des alertes
  # - Pas besoin d'Elasticsearch (mode embedded)
  # - Parfait pour un environnement de test/apprentissage
  # - Acc√®s: http://localhost:5636
  visualizer:
    image: jasonish/evebox:latest
    container_name: suricata_evebox
    networks:
      - suricata_net
    ports:
      - "5636:5636"  # Port par d√©faut d'EveBox
    volumes:
      # Monte les logs en lecture seule
      - ./logs:/var/log/suricata:ro
    # Mode serveur avec lecture directe des logs
    command: evebox server -D /var/log/suricata
    depends_on:
      - suricata  # Attend que Suricata soit d√©marr√©
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # AUTO-RELOADER (Rechargement automatique des r√®gles)
  # ---------------------------------------------------------------------------
  # Surveille les modifications et recharge Suricata
  #
  # POURQUOI USR2?
  # - Signal sp√©cifique √† Suricata pour le rechargement des r√®gles
  # - Ne coupe pas les connexions en cours
  # - Plus rapide qu'un red√©marrage complet
  suricata-reloader:
    image: alpine
    container_name: suricata_reloader
    networks:
      - suricata_net
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./rules:/rules  # R√©pertoire surveill√©
    entrypoint: /bin/sh -c "apk add --no-cache docker-cli inotify-tools &&
      while inotifywait -r -e modify /rules; do
        echo '[RELOAD] Suricata rules changed, sending USR2...';
        docker kill -s USR2 suricata_ids;
      done"
    restart: unless-stopped
