# =============================================================================
# SNORT LAB - Laboratoire de test IDS Snort 3
# =============================================================================
#
# ARCHITECTURE (Mermaid):
# ```mermaid
# graph TB
#     subgraph snort_net["snort_net 172.28.0.0/24"]
#         subgraph SHARED["Namespace r√©seau partag√©"]
#             TARGET["üéØ target_snort<br/>172.28.0.100"]
#             SNORT["üõ°Ô∏è snort_ids<br/>(network_mode: service:target)"]
#         end
#         EDITOR["üìù snort_editor<br/>:8081"]
#         RELOAD["üîÑ snort_reloader"]
#     end
#     SNORT -->|sniff eth0| TARGET
#     RELOAD -->|SIGHUP| SNORT
#     LOCALHOST["üñ•Ô∏è Attaquant"] -->|nmap/scapy| TARGET
# ```
#
# NOTE: Snort partage le namespace r√©seau du target pour voir tout le trafic
#
# CHOIX STRAT√âGIQUES:
# - R√©seau isol√©: Chaque IDS a son propre sous-r√©seau pour √©viter
#   les interf√©rences et simuler un environnement r√©aliste
# - IP fixes: Permet de cibler pr√©cis√©ment les machines dans les scans
# - Reloader automatique: D√©tecte les modifications de r√®gles et
#   recharge Snort sans red√©marrage (signal SIGHUP)
#
# PORTS EXPOS√âS:
# - 8081: Interface web FileBrowser pour √©diter les r√®gles
#
# COMMANDES UTILES:
# - D√©marrer: docker compose up -d
# - Logs Snort: docker logs -f snort_ids
# - Forcer reload: docker kill -s SIGHUP snort_ids
# =============================================================================

networks:
  snort_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/24  # Sous-r√©seau d√©di√© au lab Snort

services:
  # ---------------------------------------------------------------------------
  # SNORT IDS ENGINE
  # ---------------------------------------------------------------------------
  # Image officielle Cisco Talos Snort 3
  # Capture le trafic sur eth0 et g√©n√®re des alertes selon les r√®gles
  #
  # NETWORK_MODE: service:target-snort
  # Partage le namespace r√©seau du target pour voir TOUT le trafic
  snort-engine:
    image: ciscotalos/snort3
    container_name: snort_ids
    network_mode: "service:target-snort"  # Partage le namespace r√©seau
    depends_on:
      - target-snort  # Le target doit d√©marrer en premier
    user: root  # N√©cessaire pour la capture r√©seau avec afpacket DAQ
    cap_add:
      - NET_ADMIN  # N√©cessaire pour la capture r√©seau (promiscuous mode)
      - NET_RAW    # N√©cessaire pour les raw sockets
    volumes:
      # Monte le r√©pertoire de configuration local
      # Contient: snort.lua (config) et local.rules (r√®gles personnalis√©es)
      - ./config:/etc/snort
      # Logs persistants
      - ./logs:/var/log/snort
    # Commande Snort:
    # -c: fichier de configuration
    # -i eth0: interface √† surveiller (celle du target)
    # -A alert_fast: format d'alerte compact
    # -l: r√©pertoire de logs
    # Note: Le binaire Snort est install√© dans /home/snorty/snort3/bin/
    # On override l'entrypoint car le default lance bash et exit imm√©diatement
    entrypoint: ""
    command: ["/home/snorty/snort3/bin/snort", "-c", "/etc/snort/snort.lua", "-i", "eth0", "-A", "alert_fast", "-l", "/var/log/snort"]
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # TARGET SERVER (Serveur cible vuln√©rable)
  # ---------------------------------------------------------------------------
  # Serveur multi-services pour tester les d√©tections IDS
  # Services: HTTP(80), SSH(22), FTP(21), API(8080)
  target-snort:
    build:
      context: ../target-server  # Dockerfile partag√© entre tous les labs
      dockerfile: Dockerfile
    container_name: target_snort
    hostname: acme-server  # Hostname r√©aliste pour les scans
    networks:
      snort_net:
        ipv4_address: 172.28.0.100  # IP cible pour les attaques
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # FILEBROWSER (√âditeur de r√®gles web)
  # ---------------------------------------------------------------------------
  # Interface web pour √©diter les r√®gles Snort sans SSH
  # Acc√®s: http://localhost:8081
  snort-editor:
    image: filebrowser/filebrowser
    container_name: snort_editor
    networks:
      - snort_net
    ports:
      - "8081:80"  # Port expos√© sur l'h√¥te
    volumes:
      - ./config:/srv  # Expose le r√©pertoire de config
    environment:
      - FB_BASEURL=/
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # AUTO-RELOADER (Rechargement automatique des r√®gles)
  # ---------------------------------------------------------------------------
  # Surveille les modifications de fichiers avec inotify
  # Envoie SIGHUP √† Snort pour recharger les r√®gles sans red√©marrage
  #
  # POURQUOI SIGHUP?
  # - Snort 3 supporte le rechargement √† chaud via SIGHUP
  # - √âvite l'interruption de service pendant les tests
  # - Permet de modifier les r√®gles en temps r√©el
  snort-reloader:
    image: alpine
    container_name: snort_reloader
    networks:
      - snort_net
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # Acc√®s √† l'API Docker
      - ./config:/config  # R√©pertoire surveill√©
    entrypoint: /bin/sh -c "apk add --no-cache docker-cli inotify-tools &&
      while inotifywait -r -e modify /config; do
        echo '[RELOAD] Snort rules changed, sending SIGHUP...';
        docker kill -s SIGHUP snort_ids;
      done"
    restart: unless-stopped
